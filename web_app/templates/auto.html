{% extends "base.html" %}

{% block title %}OpenClaw FundCoach - 自动模式{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-robot"></i> 自动模式</h2>
        <p>全市场基金筛选，基于因子模型自动构建最优投资组合。</p>
        
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">参数设置</h5>
                <form id="autoForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="riskTolerance" class="form-label">风险偏好</label>
                            <select class="form-select" id="riskTolerance" name="risk_tolerance">
                                <option value="low">保守型</option>
                                <option value="medium" selected>稳健型</option>
                                <option value="high">激进型</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="investmentHorizon" class="form-label">投资期限（年）</label>
                            <input type="number" class="form-control" id="investmentHorizon" name="investment_horizon" value="3" min="1" max="10">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="fundPool" class="form-label">基金池（可选，逗号分隔）</label>
                        <input type="text" class="form-control" id="fundPool" name="fund_pool" placeholder="例如: 000001,000002,000003">
                        <div class="form-text">留空则使用全市场基金</div>
                    </div>
                    <button type="submit" class="btn btn-primary" id="analyzeBtn">
                        <i class="fas fa-chart-line"></i> 开始分析
                    </button>
                </form>
            </div>
        </div>
        
        <div id="resultsSection" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">分析结果</h5>
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('autoForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const analyzeBtn = document.getElementById('analyzeBtn');
    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 分析中...';
    analyzeBtn.disabled = true;
    
    try {
        // 获取表单数据
        const formData = new FormData(this);
        const riskTolerance = formData.get('risk_tolerance');
        const investmentHorizon = parseInt(formData.get('investment_horizon'));
        const fundPool = formData.get('fund_pool');
        
        // 构建基金代码列表
        let fundCodes = [];
        if (fundPool.trim()) {
            fundCodes = fundPool.split(',').map(code => code.trim()).filter(code => code.length === 6 && /^\d+$/.test(code));
        }
        
        // 如果没有指定基金池，使用示例基金
        if (fundCodes.length === 0) {
            fundCodes = ['000001', '000002', '000003', '000004', '000005'];
        }
        
        // 调用API
        const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                fund_codes: fundCodes,
                mode: 'auto',
                preferences: {
                    risk_tolerance: riskTolerance,
                    investment_horizon: investmentHorizon
                }
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayResults(result.data);
        } else {
            alert('分析失败: ' + result.error);
        }
    } catch (error) {
        alert('请求失败: ' + error.message);
    } finally {
        analyzeBtn.innerHTML = '<i class="fas fa-chart-line"></i> 开始分析';
        analyzeBtn.disabled = false;
    }
});

function displayResults(data) {
    const resultsSection = document.getElementById('resultsSection');
    const resultsContent = document.getElementById('resultsContent');
    
    // 构建HTML内容
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h6>组合概览</h6>
                <ul class="list-group">
                    <li class="list-group-item">预期年化收益: ${(data.analysis_results.portfolio_results.annual_return * 100).toFixed(2)}%</li>
                    <li class="list-group-item">波动率: ${(data.analysis_results.portfolio_results.volatility * 100).toFixed(2)}%</li>
                    <li class="list-group-item">最大回撤: ${(data.analysis_results.portfolio_results.max_drawdown * 100).toFixed(2)}%</li>
                    <li class="list-group-item">夏普比率: ${data.analysis_results.portfolio_results.sharpe_ratio.toFixed(2)}</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>选中基金</h6>
                <ul class="list-group">
                    ${Object.entries(data.analysis_results.portfolio_weights).map(([code, weight]) => 
                        `<li class="list-group-item">${code}: ${(weight * 100).toFixed(1)}%</li>`
                    ).join('')}
                </ul>
            </div>
        </div>
        
        <div class="mt-4">
            <h6>风险提示</h6>
            <div class="alert alert-warning">${data.risk_disclosure}</div>
        </div>
        
        <div class="mt-4">
            <h6>可视化图表</h6>
            <p>图表功能将在后续版本中完善</p>
        </div>
    `;
    
    resultsContent.innerHTML = html;
    resultsSection.style.display = 'block';
    
    // 滚动到结果区域
    resultsSection.scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}